<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.taihe.back.suppliers.mapper.ContactMapper">

    <!-- 基本条件查询联系人 -->
    <select id="selectContactsByCondition" resultType="com.cn.taihe.back.suppliers.entity.SupplierContact">
        SELECT * FROM supplier_contacts
        <where>
            <if test="supplierId != null and supplierId != ''">
                AND supplier_id = #{supplierId}
            </if>
            <if test="name != null and name != ''">
                AND name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="department != null and department != ''">
                AND department = #{department}
            </if>
            <if test="isPrimary != null">
                AND is_primary = #{isPrimary}
            </if>
        </where>
        ORDER BY is_primary DESC, created_at DESC
    </select>

    <!-- 复杂条件查询联系人 -->
    <select id="selectContactsByMapCondition" resultType="com.cn.taihe.back.suppliers.entity.SupplierContact">
        SELECT * FROM supplier_contacts
        <where>
            <if test="condition.supplierId != null and condition.supplierId != ''">
                AND supplier_id = #{condition.supplierId}
            </if>
            <if test="condition.name != null and condition.name != ''">
                AND name LIKE CONCAT('%', #{condition.name}, '%')
            </if>
            <if test="condition.position != null and condition.position != ''">
                AND position = #{condition.position}
            </if>
            <if test="condition.department != null and condition.department != ''">
                AND department = #{condition.department}
            </if>
            <if test="condition.isPrimary != null">
                AND is_primary = #{condition.isPrimary}
            </if>
            <if test="condition.phone != null and condition.phone != ''">
                AND phone LIKE CONCAT('%', #{condition.phone}, '%')
            </if>
        </where>
        <if test="condition.orderBy != null and condition.orderBy != ''">
            ORDER BY ${condition.orderBy}
            <if test="condition.asc != null and condition.asc">
                ASC
            </if>
            <if test="condition.asc != null and !condition.asc">
                DESC
            </if>
        </if>
    </select>

    <!-- 批量插入联系人 -->
    <insert id="batchInsertContacts" parameterType="list">
        INSERT INTO supplier_contacts (
        id, supplier_id, name, position, department,
        phone, mobile, email, wechat, qq,
        is_primary, created_at, updated_at, remark
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.id}, #{item.supplierId}, #{item.name},
            #{item.position}, #{item.department}, #{item.phone},
            #{item.mobile}, #{item.email}, #{item.wechat},
            #{item.qq}, #{item.isPrimary}, #{item.createdAt},
            #{item.updatedAt}, #{item.remark}
            )
        </foreach>
    </insert>

    <!-- 批量删除联系人 -->
    <delete id="batchDeleteContacts">
        DELETE FROM supplier_contacts WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 根据供应商ID批量删除联系人 -->
    <delete id="batchDeleteBySupplierIds">
        DELETE FROM supplier_contacts WHERE supplier_id IN
        <foreach collection="supplierIds" item="supplierId" open="(" separator="," close=")">
            #{supplierId}
        </foreach>
    </delete>

    <!-- 更新主联系人状态 -->
    <update id="updatePrimaryStatus">
        UPDATE supplier_contacts
        SET is_primary = #{isPrimary}, updated_at = NOW()
        WHERE id = #{id}
    </update>
</mapper>