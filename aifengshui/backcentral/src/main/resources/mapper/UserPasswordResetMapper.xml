<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.taihe.back.user.mapper.UserPasswordResetMapper">

    <!-- 结果映射 -->
    <resultMap id="UserPasswordResetResultMap" type="com.cn.taihe.back.user.entity.UserPasswordReset">
        <id property="id" column="id" />
        <result property="userId" column="user_id" />
        <result property="token" column="token" />
        <result property="expiresAt" column="expires_at" />
        <result property="isUsed" column="is_used" />
        <result property="createdAt" column="created_at" />
    </resultMap>

    <!-- 插入密码重置令牌 -->
    <insert id="insert" parameterType="com.cn.taihe.back.user.entity.UserPasswordReset"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_password_reset (
        user_id,
        token,
        expires_at,
        is_used
        ) VALUES (
        #{userId},
        #{token},
        #{expiresAt},
        #{isUsed}
        )
    </insert>

    <!-- 查询有效的重置令牌 -->
    <select id="findValidByToken" parameterType="string" resultMap="UserPasswordResetResultMap">
        SELECT * FROM user_password_reset
        WHERE token = #{token}
        AND is_used = 0
        AND expires_at > NOW()
    </select>

    <!-- 标记令牌为已使用 -->
    <update id="markAsUsed" parameterType="long">
        UPDATE user_password_reset
        SET is_used = 1
        WHERE id = #{id}
    </update>

    <!-- 删除过期令牌 -->
    <delete id="deleteExpiredTokens">
        DELETE FROM user_password_reset
        WHERE expires_at = 0
    </delete>

    <!-- 根据用户ID查询最新令牌 -->
    <select id="findLatestByUserId" parameterType="long" resultMap="UserPasswordResetResultMap">
        SELECT * FROM user_password_reset
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 统计用户未使用的令牌数量 -->
    <select id="countUnusedTokensByUser" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM user_password_reset
        WHERE user_id = #{userId}
        AND is_used = 0
        AND expires_at > NOW()
    </select>
</mapper>